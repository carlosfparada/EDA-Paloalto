---

- name: Firewalls Palo Alto setup
  hosts: panos
  connection: local
  gather_facts: no
  vars_files:
    - vars/main.yml
  tasks:
    - name: Create admin user for manual changes
      paloaltonetworks.panos.panos_administrator:
        provider: '{{ panos_provider }}'
        admin_username: 'adminmanual'
        admin_password: 'Cisco123'
        superuser: true
      
    # HTTP Server Profile
    # https://docs.paloaltonetworks.com/pan-os/9-1/pan-os-admin/monitoring/use-syslog-for-monitoring/syslog-field-descriptions/config-log-fields 
    - name: Create a HTTP Server Profile for Config Logs
      paloaltonetworks.panos.panos_http_profile:
        provider: "{{ panos_provider }}"
        name: "{{ profile_name }}"
        config_name: 'config-logs-to-eda'
        #decryption_uri_format: 'https://test'
        config_uri_format: '/test'
        config_payload: >
          {
              "receive_time": "$receive_time",
              "device_name": "$device_name",
              "serial": "$serial",
              "host": "$host",
              "seqno": "$seqno",
              "type": "$type",
              "dg_id": "$dg_id",
              "type": "$type",
              "subtype": "$subtype",
              "vsys": "$vsys",
              "vsys_name": "$vsys_name",
              "admin": "$admin",
              "client": "$client",
              "cmd": "$cmd",
              "path": "$path",
              "result": "$result",
              "comment": "$comment",
              "before_change_detail": "$before-change-detail",
              "after_change_detail": "$after-change-detail"
          }

    - name: Create HTTP server
      paloaltonetworks.panos.panos_http_server:
        provider: '{{ panos_provider }}'
        http_profile: '{{ profile_name }}'
        name: 'my-EDA-server'
        address: "{{ httpd_address }}"
        protocol: HTTP
        http_method: 'POST'
        http_port: 5000

    - name: Add a HTTP header to HTTP Server Profile
      paloaltonetworks.panos.panos_http_profile_header:
        provider: '{{ panos_provider }}'
        http_profile: '{{ profile_name }}'
        log_type: 'config'
        header: 'Content-Type'
        value: 'application/json'

    - name: Add a param to the config log type
      paloaltonetworks.panos.panos_http_profile_param:
        provider: '{{ panos_provider }}'
        http_profile: '{{ profile_name }}'
        log_type: 'config'
        param: 'serial'
        value: '$serial'

    # Log Forwarding Profile
    # - name: Create log forwarding profile
    #   paloaltonetworks.panos.panos_log_forwarding_profile:
    #     provider: '{{ panos_provider }}'
    #     name: 'Config_forward_profile'
    #     #enhanced_logging: true

    # - name: Create log forwarding profile match list
    #   paloaltonetworks.panos.panos_log_forwarding_profile_match_list:
    #     provider: '{{ panos_provider }}'
    #     log_forwarding_profile: 'Config_forward_profile'
    #     name: 'Config_forward_profile_ML'
    #     log_type: config
    #     #filter: '( user eq admin ) or ( user neq admin )'
    #     #filter: '(true eq true)'
    #     filter: "All Logs"
    #     http_profiles: ['{{ profile_name }}']

    - name: Forward Config Logs to EDA source
      paloaltonetworks.panos.panos_type_cmd:
        provider: '{{ panos_provider }}'
        cmd: set
        #cmd: 'set shared log-settings config match-list "Config Logs" filter "All Logs" send-http {{ profile_name }}'
        xpath: |
          shared/log-settings/config/match-list
        element: |
          <entry name="Config Logs">
            <filter>All Logs</filter>
            <send-http>my_profile</send-http>
          </entry>

    - name: Commit configuration
      paloaltonetworks.panos.panos_commit_firewall:
        provider: "{{ panos_provider }}"